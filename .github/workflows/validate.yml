name: Validate Docker Image ğŸ³
on:
  push:
    branches-ignore:
      - main
      - beta
  workflow_dispatch:
jobs:
  build:
    name: Build and Validate ğŸ
    runs-on: ubuntu-latest

    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v4

      - name: Set up Docker Buildx ğŸ› ï¸
        uses: docker/setup-buildx-action@v3

      - name: Build Docker Image ğŸ³
        uses: docker/build-push-action@v6
        env:
          GAME: cstrike
        with:
          context: ./container
          build-args: GAME=cstrike
          load: true

      - name: Get Docker Image ID ğŸ†”
        id: get_image_id
        run: echo "::set-output name=image_id::$(docker images -q | head -n 1)"

      - name: Add Custom Mod Content ğŸ“‚
        run: |
          mkdir -p ./mods
          mkdir -p ./mods/decay
          touch ./mods/decay/plugin.ini

      - name: Add Configuration ğŸ“‚
        run: |
          mkdir -p ./config
          touch ./config/test.cfg

      - name: List Contents of Directories ğŸ“‚
        run: |
          echo "Listing contents of ./config:"
          ls ./config
          echo "Listing contents of ./mods:"
          ls ./mods
          echo "Listing contents of ./mods/decay:"
          ls ./mods/decay
          echo "Listing contents of ./config:"
          ls ./config

      - name: Run Docker Container ğŸ³
        run: |
          docker run -d -ti \
            --name hlds ${{ steps.get_image_id.outputs.image_id }} \
            -v "$(pwd)/config:/temp/config" \
            -v "$(pwd)/mods:/temp/mods" \
            -p 27015:27015/udp \
            -p 27015:27015 \
            -p 26900:26900/udp \
            -e GAME=${{ env.GAME }} \
            "+log on +rcon_password changeme +maxplayers 12 +map cs_italy"

      - name: Inspect Container Directories ğŸ•µï¸â€â™‚ï¸
        run: |
          echo "Listing contents of /opt/steam:"
          docker exec hlds ls /opt/steam
          echo "Listing contents of /opt/steam/hlds:"
          docker exec hlds ls /opt/steam/hlds
          echo "Listing contents of /opt/steam/hlds/decay:"
          docker exec hlds ls /opt/steam/hlds/decay
          echo "Listing contents of /opt/steam/hlds/cstrike:"
          docker exec hlds ls /opt/steam/hlds/cstrike

      - name: Validate Directory Mappings ğŸ“‚
        run: |
          # Check if plugin.ini exists in the decay directory
          if [ "$(docker exec hlds ls /opt/steam/hlds/decay | grep -c 'plugin.ini')" -eq 0 ]; then
            echo "plugin.ini file is missing in the decay directory!"
            exit 1
          fi

          # Check if test.cfg exists in the cstrike directory
          if [ "$(docker exec hlds ls /opt/steam/hlds/cstrike | grep -c 'test.cfg')" -eq 0 ]; then
            echo "test.cfg file is missing in the cstrike directory!"
            exit 1
          fi

          echo "Volume mappings work as expectected!"

      - name: Cleanup ğŸ§¹
        if: always()
        run: |
          docker stop hlds
          docker rm hlds
